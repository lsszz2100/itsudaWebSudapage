<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace ="itsuda.community">


<!-- <typeAlias type="com.itsuda.community.vo.CommunityVO" alias="CommunityVO"/> -->
<!--     	<typeAlias type="com.itsuda.community.vo.ReplyVO" alias="ReplyVO"/> -->


<!-- 	출력 --> 
<!-- 	<select id="list" resultType="com.itsuda.community.vo.ReplyVO"> -->
<!-- 	SELECT -->
<!-- 		REPLY_NO -->
<!-- 		,SEQ -->
<!-- 		,REPLY_TEXT -->
<!-- 		,REPLY_WRITER -->
<!-- 		,date_format(REG_DATE, "%Y-%c-%e %r") AS REG_DATE -->
<!-- 		,date_format(UPDATE_DATE, "%Y-%c-%e %r") AS UPDATE_DATE -->
<!-- 	FROM -->
<!-- 		TB_COMMUNITY_REPLY -->
<!-- 	WHERE -->
<!-- 		seq = #{seq} AND REPARENT = 0 -->
<!-- 	ORDER BY REPLY_NO DESC -->
<!-- 	</select> -->

<!--     입력 -->
    <insert id="create">
        INSERT INTO TB_COMMUNITY_REPLY (
            SEQ
            , REPLY_TEXT
            , REPLY_WRITER
        ) VALUES (
            #{seq}
            , #{replyText}
            , #{replyWriter}
        )
    </insert>
    
    <!-- 대댓글 입력-->
    <insert id="createSubReply">
        INSERT INTO TB_COMMUNITY_REPLY
		(
			SEQ,
			REPLY_TEXT,
			REPLY_WRITER,
			REG_DATE,
			UPDATE_DATE,
			REPARENT,
			REORDER
		)
		VALUES
		(
			#{seq}
			, #{replyText}
			, #{replyWriter}
			, NOW()
			, NOW()
			, #{reparent}
			, GEN_COMMUNITY_REPLY_ORDER(#{seq},#{reparent})
		)
    </insert>
    

    <!--수정-->
    <update id="update">
        UPDATE 
        	TB_COMMUNITY_REPLY
        SET 
        	REPLY_TEXT = #{replyText}
        	,UPDATE_DATE = NOW()
        WHERE REPLY_NO = #{replyNo}
    </update>

    <!--삭제-->
    <delete id="delete">
        DELETE FROM 
        	TB_COMMUNITY_REPLY
        WHERE 
        	REPLY_NO = #{replyNo}
    </delete>
    
    <select id="countReplies" resultType="int">
    	SELECT
    		COUNT(SEQ)
    	FROM
    		TB_COMMUNITY_REPLY
    	WHERE
    		SEQ = #{seq}
    </select>


     
     <select id="listPaging" resultType="com.itsuda.community.vo.ReplyVO">
     SELECT 
   -- PARENT
   A.REPLY_NO AS P_REPLY_NO
   , A.SEQ AS P_SEQ
    , A.REPLY_TEXT AS P_REPLY_TEXT
    , A.REPLY_WRITER AS P_REPLY_WRITER
    , A.REG_DATE AS P_REG_DATE
    , A.UPDATE_DATE AS P_UPDATE_DATE
    -- CHILD
    , B.REPLY_NO AS C_REPLY_NO
   , B.SEQ AS C_SEQ
    , B.REPLY_TEXT AS C_REPLY_TEXT
    , B.REPLY_WRITER AS C_REPLY_WRITER
    , B.REG_DATE AS C_REG_DATE
    , B.UPDATE_DATE AS CupdateDate
    , B.REORDER
    ,CASE @GROUPING WHEN B.REPARENT THEN @RANK := @RANK +1 ELSE @RANK :=1 END AS RANKING
    ,@GROUPING := B.REPARENT
    , B.REPARENT
FROM (SELECT @GROUPING := '', @RANK := 0) XX, (
   SELECT @rownum:=@rownum+1 NO, A.*
   FROM TB_COMMUNITY_REPLY A, (SELECT @rownum:=0) R
   WHERE A.SEQ = #{seq}
   AND A.REPARENT = 0
) A 
LEFT JOIN TB_COMMUNITY_REPLY B ON B.SEQ = A.SEQ AND B.REPARENT = A.REPLY_NO 
ORDER BY A.NO DESC , B.REORDER;
</select>
     

    
</mapper>